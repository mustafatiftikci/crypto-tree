<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CryptoTree WASM Demo</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f8f9fa; color: #333; }
    h1 { color: #2c3e50; }
    .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; }
    button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
    button:hover { background: #2980b9; }
    pre { background: #f1f1f1; padding: 15px; border-radius: 5px; overflow-x: auto; }
    .success { color: #27ae60; }
    .error { color: #e74c3c; }
    .label { font-weight: bold; color: #555; }
  </style>
</head>
<body>
  <h1>CryptoTree WASM Demo</h1>
  <p>Insert a transaction and verify its proof.</p>

  <label>ID: <input type="text" id="id" value="tx1"></label><br>
  <label>From: <input type="text" id="from" value="alice"></label><br>
  <label>To: <input type="text" id="to" value="bob"></label><br>
  <label>Amount: <input type="text" id="amount" value="100"></label><br>
  <button id="insert-btn">Insert Transaction</button>
  <button id="proof-btn">Get Proof</button>
  <button id="verify-btn">Verify Proof</button>

  <h3>Output:</h3>
  <div id="output">Waiting for action...</div>

  <script type="module">
    import init, { CryptoTreeWasm } from './crypto_tree_wasm.js';

    let tree;

    async function run() {
      await init();
      tree = new CryptoTreeWasm();
      document.getElementById('output').textContent = 'CryptoTree initialized!';
    }

    async function insertTx() {
    const id = document.getElementById('id').value;
    const from = document.getElementById('from').value;
    const to = document.getElementById('to').value;
    const amountStr = document.getElementById('amount').value;
    const amount = BigInt(amountStr);

    // ✅ ADD THIS DEBUG LINE
    console.log("Inserting:", { id, from, to, amount: amount.toString() });

    try {
        const success = tree.insert(id, from, to, amount, null);
        document.getElementById('output').textContent = `Insert ${success ? 'success' : 'failed'}: ${id} (amount: ${amountStr})`;
    } catch (e) {
        document.getElementById('output').textContent = `Error: ${e.message}`;
    }
    }

    async function getProof() {
      const id = document.getElementById('id').value;
      const proof = tree.get_proof_of_inclusion(id);
      if (proof) {
        document.getElementById('output').textContent = 'Proof: ' + JSON.stringify(proof, null, 2);
      } else {
        document.getElementById('output').textContent = 'Proof not found for ID: ' + id;
      }
    }

    async function verifyProof() {
      const id = document.getElementById('id').value;
      const proof = tree.get_proof_of_inclusion(id);
      if (proof) {
        const valid = tree.verify_integrity();
        document.getElementById('output').textContent = `Integrity verified: ${valid}`;
      } else {
        document.getElementById('output').textContent = 'No proof to verify.';
      }
    }

    // ✅ Attach event listeners AFTER the module is loaded
    run().then(() => {
      document.getElementById('insert-btn').addEventListener('click', insertTx);
      document.getElementById('proof-btn').addEventListener('click', getProof);
      document.getElementById('verify-btn').addEventListener('click', verifyProof);
    });
  </script>
</body>
</html>